<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
  <script type="text/javascript">

    var peer = new Peer({
      // Set API key for cloud server (you don't need this if you're running your
      // own.
      key: '0opo1rm535xc4n29',

      // Set highest debug level (log everything!).
      debug: 3,

      // Set a logging function:
      logFunction: function() {
        var copy = Array.prototype.slice.call(arguments).join(' ');
        $('.log').append(copy + '<br>');
      }
    });


    peer.on('open', function(id){
      $('#pid').text(id);
    });

    // Await connections from others
    peer.on('connection', function(c){console.log("connection request from : "+ c.peer);connect(c)});

    peer.on('error', function(err) {
      console.log(err);
    })

    function connect(c) {
      // Handle a chat connection.

      c.on('data', function(data) {
        console.log(c.peer);
        console.log(data);
        $("#messages").append("<li> Other : "+data+"</li>")
      });
      c.on('close', function() {
        alert(c.peer + ' has left the chat.');
      });
    }

    function connect_to_id(id_) {
      var c = peer.connect(id_);
      c.on('open', function() {
        connect(c);
      });
      c.on('error', function(err) { alert(err); });
      console.log("triyng to connect to : "+id_);
    }

    $(function(){
      $('#submit').click(function(e) {
        console.log("#submit clicked");
        e.preventDefault();
        // For each active connection, send the message.
        var msg = $('#message').val();
        console.log(peer.connections)
        for (other_id in peer.connections) {
          for(var i = 0; i < peer.connections[other_id].length; i+=1){
            var c = peer.connections[other_id][i];
            c.send(msg);
            console.log("sent message : " + msg + " to : " + c.peer);
          };
        }

        $('#text').val('');
        $('#text').focus();
      });

      // Connect to a peer
      $('#connect').click(function(e) {
        console.log("#connect clicked");
        e.preventDefault();
        var requestedPeer = $('#rid').val();
        console.log("connecting to : " + requestedPeer + "...");
        connect_to_id(requestedPeer);
      });
  });


  </script>


</head>
<body>
    Your PeerJS ID is <span id="pid"></span><br>

    Connect to a peer: <input type="text" id="rid" placeholder="Someone else's id"><input class="button" type="button" value="Connect" id="connect"><br><br>

    <div>
      Messages :
      <ul id="messages">
      </ul>
    </div>
    Message : <input type="text" id="message" ><input class="button" type="submit" id="submit" value="Send to selected peers">

</body>
</html>